<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>“Hello World” explained | frublox blog</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="“Hello World” explained" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I recently wrote a small, but cryptic “Hello World” program in Python:" />
<meta property="og:description" content="I recently wrote a small, but cryptic “Hello World” program in Python:" />
<link rel="canonical" href="/blog/programming/python/obfuscation/2019/05/21/hello-world-explained.html" />
<meta property="og:url" content="/blog/programming/python/obfuscation/2019/05/21/hello-world-explained.html" />
<meta property="og:site_name" content="frublox blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-05-21T19:36:53+03:00" />
<script type="application/ld+json">
{"url":"/blog/programming/python/obfuscation/2019/05/21/hello-world-explained.html","headline":"“Hello World” explained","dateModified":"2019-05-21T19:36:53+03:00","datePublished":"2019-05-21T19:36:53+03:00","description":"I recently wrote a small, but cryptic “Hello World” program in Python:","mainEntityOfPage":{"@type":"WebPage","@id":"/blog/programming/python/obfuscation/2019/05/21/hello-world-explained.html"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/blog/feed.xml" title="frublox blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">frublox blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">&quot;Hello World&quot; explained</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-05-21T19:36:53+03:00" itemprop="datePublished">May 21, 2019
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I recently wrote a small, but cryptic “Hello World” program in Python:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="nb">ord</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x21</span><span class="p">,</span> <span class="s">"!!&amp;!!dzăC|"</span><span class="p">))</span>
<span class="n">i</span> <span class="o">=</span> <span class="s">"DÒVV×0Ë×YVR "</span>

<span class="k">while</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((((</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span></code></pre></figure>

<p>Since <a href="https://www.reddit.com/r/shittyprogramming/comments/bqw2c9/getting_started_with_python_hello_world/">/r/shittyprogramming seemed to like it</a>, I thought I’d post a write-up on how it (actually) works.</p>

<p>First, let’s deobfuscate a little:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># IO_IN
</span>    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># IO_OUT
</span>    <span class="mi">5</span><span class="p">,</span>  <span class="c1"># PC
</span>    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># ACC
</span>    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Z
</span>    <span class="mh">0x43</span><span class="p">,</span>
    <span class="mh">0x59</span><span class="p">,</span>
    <span class="mh">0xe2</span><span class="p">,</span>
    <span class="mh">0x22</span><span class="p">,</span>
    <span class="mh">0x5b</span>
<span class="p">]</span>

<span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">"Hello World"</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">while</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

    <span class="n">o</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x07</span>

    <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span></code></pre></figure>

<p>A lot easier to read now, though still not very easy to understand.</p>

<p>Essentially, we are ‘emulating’ a tiny custom CPU that has access to a very small amount of memory (the <code class="highlighter-rouge">data</code> variable). Even if you’re not that familiar with how CPUs and memory works, this setup should still be simple enough to understand.</p>

<h1 id="memory">Memory</h1>

<p>Our memory is laid out just like it’s defined in the code:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># IO_IN
</span>    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># IO_OUT
</span>    <span class="mi">5</span><span class="p">,</span>  <span class="c1"># PC
</span>    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># ACC
</span>    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Z
</span>    <span class="mh">0x43</span><span class="p">,</span>
    <span class="mh">0x59</span><span class="p">,</span>
    <span class="mh">0xe2</span><span class="p">,</span>
    <span class="mh">0x22</span><span class="p">,</span>
    <span class="mh">0x5b</span>
<span class="p">]</span></code></pre></figure>

<p>You can think of each item in the list as holding a value at a specific address in memory. <code class="highlighter-rouge">data[0]</code> retrieves the value stored at memory address 0, for example. Each value in <code class="highlighter-rouge">data</code> is exactly one byte in size.</p>

<p>The first two addresses act as memory-mapped IO ports (I’ll explain those later on).</p>

<p>The third address stores what is called the <em>program counter</em> register, or PC for short. The PC holds the address of the next instruction to execute. It is initialized to 5 here, because <code class="highlighter-rouge">data[5]</code> holds the address of the first instruction, <code class="highlighter-rouge">0x43</code>. More on instructions in a bit.</p>

<p>Next, we have at <code class="highlighter-rouge">data[3]</code> the <em>accumulator</em> register, or <code class="highlighter-rouge">ACC</code> for short. This is a general-purpose register, for storing whatever the programmer of this CPU wants. Lots of real CPUs have a register like this for storing the result of arithmetic operations. In our case, it’s just a free slot in memory that we can read and write to, with a useful side effect, covered in the next paragraph.</p>

<p>At <code class="highlighter-rouge">data[4]</code> lies the <em>zero flag</em> register, or <code class="highlighter-rouge">Z</code> for short. In almost all CPUs, there will be a flag register where certain bits in that register being 1 or 0 will signify something has happened in the CPU. For example, if the result of an addition is 0, then the bit representing the <code class="highlighter-rouge">Z</code> flag may be set to 1. This CPU is very minimal, so the <code class="highlighter-rouge">Z</code> flag is the only flag. It is automatically set to 1 whenever the value in ACC becomes 0, and is reset when it changes again to something not 0.</p>

<p>Only the first 5 addresses are ‘special’. Values in <code class="highlighter-rouge">data[5]</code> and onwards hold instructions for the actual program the CPU will be executing.</p>

<h1 id="instructions">Instructions</h1>

<p>Instructions are encoded in a special format. Every instruction is exactly one byte, which helps simplify implementing the CPU a bit.</p>

<p>The format of an instruction is as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OOXXXYYY
</code></pre></div></div>

<p>Each letter represents one bit. The <code class="highlighter-rouge">O</code> bits represent the <em>opcode</em>, which determine which instruction the CPU is going to execute. The <code class="highlighter-rouge">X</code> and <code class="highlighter-rouge">Y</code> bits represent the parameters for the instruction. In this CPU, every instruction has exactly 2 parameters, which we will call simply <code class="highlighter-rouge">x</code> and <code class="highlighter-rouge">y</code>.</p>

<p>There are only two <code class="highlighter-rouge">O</code> bits, which means there can be at most 4 different instructions in this CPU. This is actually (more than) enough for our needs.</p>

<p>Here are the opcodes paired with their corresponding instructions:</p>

<ul>
  <li><code class="highlighter-rouge">00</code>: Store the value x at the address y
    <ul>
      <li>Mnemonic: <code class="highlighter-rouge">mov x, [y]</code></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">01</code>: Store the <em>contents</em> of address x at address y
    <ul>
      <li>Mnemonic: <code class="highlighter-rouge">mov [x], [y]</code></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">10</code>: Add x to the <em>contents</em> of address y, storing the result at address y
    <ul>
      <li>Mnemonic: <code class="highlighter-rouge">add x, [y]</code></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">11</code>: Add the <em>contents</em> of address x to the <em>contents</em> of address y, storing the result at address y
    <ul>
      <li>Mnemonic: <code class="highlighter-rouge">add [x], [y]</code></li>
    </ul>
  </li>
</ul>

<p>The mnemonics are just convenient names for the instructions, and should be familiar if you’ve written assembly before. They follow the format <code class="highlighter-rouge">&lt;op_name&gt; &lt;src&gt;, &lt;dst&gt;</code>, meaning that the result of the operation is stored at the address specified by the second argument. In some assembly syntaxes, <code class="highlighter-rouge">&lt;dst&gt;</code> and <code class="highlighter-rouge">&lt;src&gt;</code> are the other way around, i.e. <code class="highlighter-rouge">&lt;op_name&gt; &lt;dst&gt;, &lt;src&gt;</code>.</p>

<p><code class="highlighter-rouge">x</code> (without brackets) means the literal value represented by <code class="highlighter-rouge">x</code> is used as the argument, and <code class="highlighter-rouge">[x]</code> means that the value <em>stored at the address</em> <code class="highlighter-rouge">x</code> is used as the argument. <code class="highlighter-rouge">y</code> is always surrounded by brackets since it always refers to an address that we end up storing the result into.</p>

<p>I actually didn’t end up using <code class="highlighter-rouge">add x, [y]</code> in the Hello World program, but I kept it anyway.</p>

<p>With that, let’s try understanding the first instruction, which is stored at <code class="highlighter-rouge">data[5]</code>, <code class="highlighter-rouge">0x43</code>.</p>

<p>Here is <code class="highlighter-rouge">0x43</code> in binary:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>01 000 011
</code></pre></div></div>

<p>The first two bits signify that this is the <code class="highlighter-rouge">mov [x], [y]</code> instruction. In particular, <code class="highlighter-rouge">x</code> here is 0 and <code class="highlighter-rouge">y</code> is 3 (binary <code class="highlighter-rouge">011</code>). Since they both refer to addresses, this means that we’re taking the value stored at address 0 and storing (i.e. copying) it into address 3. In case you forgot, address 0 is the I/O input port (<code class="highlighter-rouge">IO_IN</code>) and address 3 is the accumulator (<code class="highlighter-rouge">ACC</code>).</p>

<p>Reading from address 0 is handled differently by the CPU than reading other addresses. When the CPU sees that address 0 is read from, it will first write one byte of ‘input’ (we’ll see how this is implemented later) to address 0, then lets the operation proceed as normal.</p>

<p>So, ultimately this instruction will read one byte of input and store it into <code class="highlighter-rouge">ACC</code>.</p>

<h1 id="the-decoded-program">The decoded program</h1>

<p>I’ll save a bit of time and just write the mnemonics for all of the instructions in the program:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mov [0], [3]
mov [3], [1]
add [4], [2]
mov 5, [2]
mov [3], [3]
</code></pre></div></div>

<p>Replacing special addresses with their name:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mov IO_IN, ACC
mov ACC, IO_OUT
add Z, PC
mov 4, PC
mov ACC, ACC
</code></pre></div></div>

<p>The full program should be a little clearer now.</p>

<ol>
  <li>Read a byte of input, store it into <code class="highlighter-rouge">ACC</code></li>
  <li>Output the value of <code class="highlighter-rouge">ACC</code></li>
  <li>Add the value of <code class="highlighter-rouge">Z</code> to <code class="highlighter-rouge">PC</code></li>
  <li>Set the value of <code class="highlighter-rouge">PC</code> to 4</li>
  <li>Move the value of <code class="highlighter-rouge">ACC</code> into <code class="highlighter-rouge">ACC</code></li>
</ol>

<p>That 5th instruction may seem a little weird. It’s actually not necessary here due to how the CPU is implemented, but I decided to keep it as an example of what’s called a <em>no-op</em> instruction. It does nothing but waste a little bit of CPU time, and is often implemented as moving the value of a register into itself.</p>

<p>The 3rd instruction is a <em>jump instruction</em> in disguise. Jump instructions are instructions that change the flow of control, sometimes based on particular conditions (like certain flags). A jump changes the value of <code class="highlighter-rouge">PC</code> to something specific, so that the next instruction to be executed is not simply the one in the next memory address.</p>

<p>Rather than having a separate instruction for jumping to a specific address if the <code class="highlighter-rouge">Z</code> flag is flipped on, I simply add the value of <code class="highlighter-rouge">Z</code> register to <code class="highlighter-rouge">PC</code> using the already-available <code class="highlighter-rouge">add</code> instruction. If the <code class="highlighter-rouge">ACC</code> does not contain 0, then 0 is added and nothing changes (i.e. the next instruction is executed as normal). But if it’s 1, then the CPU will skip over the next instruction (since the <code class="highlighter-rouge">PC</code> is also automatically incremented by 1 after every instruction), thereby changing the operation.</p>

<p>The 4th instruction is what’s usually called an <em>unconditional jump</em>, i.e. changing the value of <code class="highlighter-rouge">PC</code>  without checking for any conditions. Here, we store 4 into <code class="highlighter-rouge">PC</code>. Taking into account that <code class="highlighter-rouge">PC</code> is incremented after every instruction, this means that the value of <code class="highlighter-rouge">PC</code> will be 5 after this instruction is executed, and so the CPU will go execute the first instruction again.</p>

<p>If the value of <code class="highlighter-rouge">Z</code> was 1, the CPU will execute the 5th instruction instead of the 4th, and so the no-op will be executed. When our CPU reaches the end of memory (i.e. the value in <code class="highlighter-rouge">PC</code> is too big), the CPU stops executing. This is why I mentioned that the no-op wasn’t necessary, since <code class="highlighter-rouge">PC</code> would have a too-big value in it if 1 was added to it.</p>

<h1 id="implementing-the-cpu">Implementing the CPU</h1>

<p>That was a lot to go through! But now comes the (slightly) simpler part: implementing the CPU.</p>

<p>Here is the outline of what the CPU actually does:</p>

<ol>
  <li>Read the byte stored at the address specified by <code class="highlighter-rouge">PC</code></li>
  <li>Decode the byte into an instruction: the opcode <code class="highlighter-rouge">o</code> and the arguments <code class="highlighter-rouge">x</code> and <code class="highlighter-rouge">y</code></li>
  <li>Handle each of the four possible instructions</li>
  <li>Increment the value in <code class="highlighter-rouge">PC</code> by 1</li>
  <li>Set <code class="highlighter-rouge">Z</code> to 1 if <code class="highlighter-rouge">ACC</code> is 0</li>
</ol>

<p>The relevant code:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">while</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

    <span class="n">o</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x07</span>

    <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span></code></pre></figure>

<p>The first line just checks the stop condition we described earlier: does <code class="highlighter-rouge">PC</code> (found at <code class="highlighter-rouge">data[2]</code>) specify an address that is too high? If it’s not too high, then we proceed.</p>

<p><br /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

<span class="n">o</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x07</span></code></pre></figure>

<p><code class="highlighter-rouge">b</code> is the byte stored at the address specified by <code class="highlighter-rouge">PC</code>. <code class="highlighter-rouge">o</code>, <code class="highlighter-rouge">x</code>, and <code class="highlighter-rouge">y</code> are extracted by <em>masking</em> and <em>shifting</em> bits. I won’t go into this part here, but essentially this is how you extract specific bits of a number.</p>

<p><br /></p>

<p>Next comes a very simple <code class="highlighter-rouge">if</code> block, with four branches – one for each possible instruction.</p>

<p><br /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span></code></pre></figure>

<p>Opcode <code class="highlighter-rouge">00</code> is simple: take <code class="highlighter-rouge">x</code> and store it at address <code class="highlighter-rouge">y</code>. We can also see special treatment for I/O: if the destination address was 1 (the <code class="highlighter-rouge">IO_OUT</code> address), then we additionally print the value of <code class="highlighter-rouge">IO_OUT</code> to the console.</p>

<p><br /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span></code></pre></figure>

<p>Opcode <code class="highlighter-rouge">01</code> is a little more complex, because we have to deal with input as well as output. If the source argument <code class="highlighter-rouge">x</code> is the <code class="highlighter-rouge">IO_IN</code> address (0), then we need to first store a byte of ‘input’ at <code class="highlighter-rouge">data[0]</code>:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span></code></pre></figure>

<p>The ‘input’ is actually just implemented as a list of the ASCII values of the string “Hello World” followed by a terminating 0, declared at the top of the code:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">"Hello World"</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span></code></pre></figure>

<p>This is also why the program checks that <code class="highlighter-rouge">ACC</code> is 0. If <code class="highlighter-rouge">ACC</code> is 0, that means we’ve read the whole string, and can terminate the program. As an aside, this is how strings are represented in a lot of languages, and this representation is usually called <em>null-terminated</em>.</p>

<p>After we store the first byte of the input in <code class="highlighter-rouge">data[0]</code>, we remove the first byte of <code class="highlighter-rouge">i</code> by doing <code class="highlighter-rouge">i = i[1:]</code>. This could’ve also been implemented by keeping track of the current index into the input and incrementing it.</p>

<p>Also, there is a little check to make sure that there is still input left to write:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span></code></pre></figure>

<p>This actually isn’t necessary since I never read from <code class="highlighter-rouge">IO_IN</code> after reading all the input, but it might be a nice safety feature for a different application.</p>

<p>The actual storing is very straightforward:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span></code></pre></figure>

<p>The <code class="highlighter-rouge">IO_OUT</code> address is handled the same way as for opcode <code class="highlighter-rouge">00</code>:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span></code></pre></figure>

<p><br /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span></code></pre></figure>

<p>This is the <code class="highlighter-rouge">add x, [y]</code> instruction, which is very simple to implement. As previously mentioned, it is also not actually used and so could’ve have been left unimplemented.</p>

<p><br /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">else</span><span class="p">:</span>
    <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span></code></pre></figure>

<p>Finally, this is <code class="highlighter-rouge">add [x], [y]</code>. It is also very simple, since we don’t care about I/O for <code class="highlighter-rouge">add</code> in our CPU.</p>

<p><br /></p>

<p>Now, we simply increment <code class="highlighter-rouge">PC</code> and update the <code class="highlighter-rouge">Z</code> flag by checking if <code class="highlighter-rouge">ACC</code> is 0:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span></code></pre></figure>

<p>With that, we’ve successfully implemented a tiny CPU.</p>

<h1 id="extra-obfuscation">Extra obfuscation</h1>

<p>That’s actually it for the underlying logic, but it looked a bit too clean so I decided to make it a little harder to read.</p>

<p>The first step was really simple: use less variables. Rather than have separate variables for <code class="highlighter-rouge">b</code>, <code class="highlighter-rouge">o</code>, <code class="highlighter-rouge">x</code>, and <code class="highlighter-rouge">y</code>, I just copy-pasted their definitions anywhere they were used. I also renamed <code class="highlighter-rouge">data</code> to <code class="highlighter-rouge">p</code>. The result is somewhat intimidating:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">while</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((((</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span></code></pre></figure>

<p>The second obfuscation is a little more involved: obfuscate the “Hello World” string.</p>

<p>I first performed a bitwise operation called <em>right-rotating</em> on each character. Right-rotating simply means that each bit gets shifted to the right (in this case by 1), but the right-most bit becomes the left-most bit. This differs from shifting, where the right-most bit would simply disappear and the left-most would just be 0. Rotating preserves all the bits, which means that I can perform the reverse operation, <em>left-rotating</em>, to get back the original value.</p>

<p>I then added <code class="highlighter-rouge">0x20</code> to each character (since the 0 at the end wasn’t a visually-representable ASCII code, and <code class="highlighter-rouge">0x20</code> is ASCII for the space character).</p>

<p>This (beautiful) line of code undoes those operations to get back the original character:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((((</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span></code></pre></figure>

<p>Finally, the memory was also obfuscated into a string. The obfuscation is very obvious here, namely adding <code class="highlighter-rouge">0x21</code> to each value (to make them visible ASCII characters that look a bit different to the obfuscated input).</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="nb">ord</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x21</span><span class="p">,</span> <span class="s">"!!&amp;!!dzăC|"</span><span class="p">))</span></code></pre></figure>

<h1 id="conclusions">Conclusions</h1>

<p>This post ended up being a lot longer than I expected. Hopefully, it was informative.</p>

<p>Most of the concepts here would probably be covered in an introductory class on microprocessors or other low-level computer hardware. Real CPUs are a lot more complicated (usually) but, as shown here, it doesn’t actually take too much to design a functioning (though severely limited) one. Regardless, this is definitely a fun way to obfuscate simple programs and gain a better understanding of how a CPU might work.</p>

  </div><a class="u-url" href="/blog/programming/python/obfuscation/2019/05/21/hello-world-explained.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">frublox blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">frublox blog</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/frublox"><svg class="svg-icon"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg> <span class="username">frublox</span></a></li><li><a href="https://www.twitter.com/frublox"><svg class="svg-icon"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">frublox</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>small blog about programming/tech/other</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
